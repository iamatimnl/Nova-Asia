
<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dagelijkse Bestellingen</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #f2f2f2; }
    ul { margin: 0; padding-left: 20px; }
    #totals { margin-top: 20px; }
    #totals table { width: auto; margin-top: 10px; }
    .download-buttons { margin-bottom: 20px; }
    .download-buttons button {
      margin-right: 10px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    .completed { background-color: #c8e6c9; }
    .cancelled { background-color: #e0e0e0; }
    .money { text-align:right; font-weight:700; color:#0b63b6; }
  </style>
</head>
<body>

  <h1 id="dayHeading">Vandaag</h1>

  <div style="margin-bottom:15px;">
    <label>Datum: <input type="date" id="datePicker"> <button id="dateBtn">Zoek</button></label>
    <label style="margin-left:20px;">Van: <input type="date" id="startDate"> Tot: <input type="date" id="endDate"> <button id="rangeBtn">Zoek</button></label>
  </div>

  <div class="download-buttons">
    <button id="excelBtn">üì• Download Excel</button>
    <button id="pdfBtn">üìÑ Download PDF</button>
    <button id="overviewPdfBtn">üßæ Download Overzicht</button>
  </div>

  <div id="ordersContainer">
    <p id="noOrders" style="display:none;">Geen bestellingen gevonden.</p>
    <table id="ordersTable" style="display:none;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Datum</th>
          <th>Orderd</th>
          <th>Tijdslot</th>
          <th>Type</th>
          <th>Klant</th>
          <th>Telefoon</th>
          <th>Email</th>
          <th>Items</th>
          <th>Opmerking</th>
          <th>Ordernummer</th>
          <th>Bezorgkosten (‚Ç¨)</th>
          <th>Fooi (‚Ç¨)</th>
          <th>Statiegeld (‚Ç¨)</th>
          <th>Totaal (‚Ç¨)</th>
          <th>Adres</th>
          <th>Betaling</th>
          <th>Status</th>
          <th>Actie</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="tbInput" style="margin-top:20px;">
    <h2>Thuisbezorgd invoer</h2>
    <label>Omzet totaal (incl.): <input type="number" id="tbOmzetInput" step="0.01"></label>
    <label>BTW 9%: <input type="number" id="tbBtw9Input" step="0.01"></label>
    <label>BTW 21%: <input type="number" id="tbBtw21Input" step="0.01"></label>
    <label>Aantal bestellingen: <input type="number" id="tbOrdersInput"></label>
    <label>Statiegeld: <input type="number" id="tbStatieInput" step="0.01"></label>
    <button id="tbSaveBtn">Opslaan</button>
  </div>

  <div id="tbDisplay" style="display:none; margin-top:20px;">
    <h2>Thuisbezorgd</h2>
    <table>
      <tr><td>BTW 9%</td><td id="tbBtw9">‚Ç¨0,00</td></tr>
      <tr><td>BTW 21%</td><td id="tbBtw21">‚Ç¨0,00</td></tr>
      <tr><td>Omzet totaal (incl.)</td><td id="tbOmzet">‚Ç¨0,00</td></tr>
      <tr><td>Aantal bestellingen</td><td id="tbOrders">0</td></tr>
      <tr><td>Statiegeld</td><td id="tbStatie">‚Ç¨0,00</td></tr>
    </table>
  </div>

  <div id="totals" style="display:none;">
  <h2>Omzet Overzicht</h2>
  <table>
    <tr><td>Totale omzet</td><td class="money" id="totalOmzet">‚Ç¨0,00</td></tr>

    <!-- Áªô 9%/21% Ë°åÂä† tr ÁöÑ idÔºåÊñπ‰æø JS ÊéßÂà∂ÊòæÁ§∫ -->
    <tr id="btw9Row"><td>BTW 9%</td><td class="money" id="btw9Amount">‚Ç¨0,00</td></tr>
    <tr id="btw21Row"><td>BTW 21%</td><td class="money" id="btw21Amount">‚Ç¨0,00</td></tr>

    <!-- BTW Totaal ‰øùÁïô‰ΩÜ JS ‰ºöÊ∞∏ËøúÈöêËóèÔºõ‰πüÂèØ‰ª•Áõ¥Êé•Âà†ÊéâËøôË°å -->
    <tr id="btwTotalRow"><td>BTW Totaal</td><td class="money" id="btwTotalAmount">‚Ç¨0,00</td></tr>

    <!-- Êñ∞Â¢ûÔºöËÆ¢ÂçïÊï∞Èáè -->
    <tr><td>Aantal Bestellingen</td><td id="totalOrders">0</td></tr>
    <tr><td>Gemiddelde Bestelwaarde</td><td id="avgOrder">‚Ç¨0,00</td></tr>

    <!-- Geannuleerd Ë°åÂä† idÔºå‰æø‰∫é‰∏∫ 0 Êó∂Êï¥Ë°åÈöêËóè -->
    <tr id="cancelledRow"><td>Geannuleerd (aantal / bedrag)</td><td id="totalCancelled">0 / ‚Ç¨0,00</td></tr>

    <tr><td>Totale korting</td><td id="totalDiscount">‚Ç¨0,00</td></tr>
    <tr><td>Totale fooi</td><td id="totalTip">‚Ç¨0,00</td></tr>
    <tr id="depositRow" style="display:none;"><td>Totale statiegeld</td><td id="totalDeposit">‚Ç¨0,00</td></tr>
    <tr><td>Bezorgkosten (bedrag / aantal)</td><td id="totalDelivery">‚Ç¨0,00 / 0</td></tr>

    <tr><td>Online betaling</td><td class="money" id="totalOnline">‚Ç¨0,00</td></tr>
    <tr><td>Pin betaling</td><td class="money" id="totalPin">‚Ç¨0,00</td></tr>
    <tr><td>Contant</td><td class="money" id="totalContant">‚Ç¨0,00</td></tr>
    <tr><td>Op rekening</td><td class="money" id="totalCredit">‚Ç¨0,00</td></tr>
    <tr><td>Thuisbezorgd totaal</td><td class="money" id="tbOverzichtTotal">‚Ç¨0,00</td></tr>
  </table>
 </div>

  <dialog id="editDialog">
    <form method="dialog" id="editForm">
      <input type="hidden" id="editId">
      <div><label>Naam: <input type="text" id="editName"></label></div>
      <div><label>Telefoon: <input type="text" id="editPhone"></label></div>
      <div><label>Email: <input type="email" id="editEmail"></label></div>
      <div><label>Opmerking: <input type="text" id="editRemark"></label></div>
      <div><label>Straat: <input type="text" id="editStreet"></label></div>
      <div><label>Huisnummer: <input type="text" id="editNumber"></label></div>
      <div><label>Postcode: <input type="text" id="editPostcode"></label></div>
      <div><label>Plaats: <input type="text" id="editCity"></label></div>
      <div><label>Afhaaltijd: <input type="text" id="editPickup"></label></div>
      <div><label>Bezorgtijd: <input type="text" id="editDelivery"></label></div>
      <div><label>Items: <textarea id="editItems"></textarea></label></div>
      <div><label>Betaalwijze: <input type="text" id="editPayment"></label></div>
      <div><label>Status: <input type="text" id="editStatus"></label></div>
      <div><label>Totaal: <input type="number" step="0.01" id="editTotaal"></label></div>
      <div><label>Bezorgkosten: <input type="number" step="0.01" id="editBezorgkosten"></label></div>
      <div><label>Fooi: <input type="number" step="0.01" id="editFooi"></label></div>
      <div><label>Statiegeld: <input type="number" step="0.01" id="editStatiegeld"></label></div>
      <menu>
        <button type="reset" id="editCancel">Annuleer</button>
        <button type="submit">Opslaan</button>
      </menu>
    </form>
  </dialog>


  <script>
    let currentQuery = { type: 'today', params: '' };
    let editDialog, editForm, currentEditData;

    function formatCurrency(value) {
      if (typeof value === 'string') {
        value = value.replace(/[^\d,.-]/g, '').replace(',', '.').trim();
      }
      const num = parseFloat(value);
      return isNaN(num) ? '‚Ç¨0,00' : '‚Ç¨' + num.toFixed(2).replace('.', ',');
    }

    function loadOrders(url, mode = 'today', label = '') {
  fetch(url)
    .then(r => r.json())
    .then(data => {
      const tbody = document.querySelector('#ordersTable tbody');
      const table = document.getElementById('ordersTable');
      const msg = document.getElementById('noOrders');
      tbody.innerHTML = '';

      // ÂàùÂßãÂåñÁªüËÆ°Êï∞ÊçÆ
      let total = 0, pin = 0, online = 0, contant = 0, credit = 0, unknown = 0;
      let cancelled = 0, cancelledCount = 0;
      let tipTotal = 0, depositTotal = 0, discountTotal = 0;
      let deliveryFeeTotal = 0, deliveryCount = 0;
      let orderCount = 0;
      let btw9Total = 0, btw21Total = 0;
      // ÊòæÁ§∫ÊàñÈöêËóèËÆ¢ÂçïË°®Ê†º
      if (data.length) {
        table.style.display = '';
        msg.style.display = 'none';
      } else {
        table.style.display = 'none';
        msg.style.display = 'block';
      }

      // ËÆæÁΩÆÊ†áÈ¢ò
      const heading = document.getElementById('dayHeading');
      if (mode === 'today') {
        heading.textContent = `Vandaag ‚Äì ${label}`;
      } else if (mode === 'date') {
        heading.textContent = `Bestellingen van ${label}`;
      } else if (mode === 'range') {
        heading.textContent = `Bestellingen van ${label}`;
      }

      // ÊîØ‰ªòÊñπÂºèÊò†Â∞ÑÂáΩÊï∞
      function normalizePaymentMethod(methodRaw) {
        const method = String(methodRaw || '').toLowerCase();
        if (['pin', 'card'].some(k => method.includes(k))) return 'pin';
        if (['online', 'online payment'].some(k => method.includes(k))) return 'online';
        if (['contant', 'cash'].some(k => method.includes(k))) return 'contant';
        if (['rekening', 'on account'].some(k => method.includes(k))) return 'rekening';
        return 'onbekend';
      }

      // Ê∏≤ÊüìÊØè‰∏ÄË°åËÆ¢Âçï
      data.forEach(order => {
        const tr = document.createElement('tr');
        const status = order.status || order.payment_status || '';
        const orderData = { ...order, status };
        tr.dataset.id = order.id;
        tr.dataset.order = JSON.stringify(orderData);
        if (order.is_cancelled) tr.classList.add('cancelled');
        else if (order.is_completed) tr.classList.add('completed');

        const isDelivery = ['delivery', 'bezorgen'].includes((order.order_type || '').toLowerCase());
        const items = Object.entries(order.items || {}).map(([n, i]) => `<li>${n} x ${i.qty}</li>`).join('');

        let fooi = parseFloat(order.fooi ?? order.tip ?? 0);
        if (isNaN(fooi)) fooi = 0;
        let statiegeld = parseFloat(order.statiegeld ?? order.deposit ?? 0);
        if (isNaN(statiegeld)) statiegeld = 0;

        let tot = order.totaal ?? order.total ?? 0;
        if (typeof tot === 'string') {
          tot = parseFloat(tot.replace(/[^\d,.-]/g, '').replace(',', '.'));
        }

        const delFee = Number(order.delivery_fee ?? order.bezorgkosten ?? 0);

        if (order.is_cancelled) {
          cancelled += tot || 0;
          cancelledCount++;
        } else {
          total += tot;
          tipTotal += fooi;
          depositTotal += statiegeld;
          discountTotal += Number(order.discountAmount ?? order.korting ?? 0);
          deliveryFeeTotal += delFee;
          if (isDelivery) deliveryCount++;
          orderCount++;
          btw9Total += Number(order.btw_9 || 0);
          btw21Total += Number(order.btw_21 || 0);
          const norm = normalizePaymentMethod(order.payment_method);
          if (norm === 'pin') pin += tot;
          else if (norm === 'online') online += tot;
          else if (norm === 'contant') contant += tot;
          else if (norm === 'rekening') credit += tot;
          else unknown += tot;
        }

        tr.innerHTML = `
          <td>${order.id || ''}</td>
          <td>${order.created_date || ''}</td>
          <td>${order.created_at || ''}</td>
          <td>${isDelivery ? (order.delivery_time || order.deliveryTime || '-') : (order.pickup_time || order.pickupTime || '-')}</td>
          <td>${isDelivery ? 'Bezorgen' : 'Afhalen'}</td>
          <td>${order.customer_name || ''}</td>
          <td>${order.phone || ''}</td>
          <td>${order.email || '-'}</td>
          <td><ul>${items}</ul></td>
          <td>${order.opmerking || order.remark || '-'}</td>
          <td>${order.order_number || ''}</td>
          <td>${isDelivery ? formatCurrency(delFee) : '-'}</td>
          <td>${formatCurrency(fooi)}</td>
          <td>${formatCurrency(statiegeld)}</td>
          <td>${formatCurrency(tot)}</td>
          <td>${isDelivery ? `${order.street} ${order.house_number} ${order.postcode} ${order.city}${order.maps_link ? ` <a href="${order.maps_link}" target="_blank">üìçMaps</a>` : ''}` : '-'}</td>
          <td>${order.payment_method || ''}</td>
          <td>${status}</td>
          <td><button onclick="toggleComplete(this)"
            data-number="${order.order_number}"
            data-name="${order.customer_name || ''}"
            data-phone="${order.phone || ''}"
            data-email="${order.email || ''}"
            data-type="${isDelivery ? 'bezorg' : 'afhaal'}">${order.is_completed ? 'Undone' : 'Klaar'}</button>
            <button onclick="editOrder(this)">Bewerk</button>
            <button onclick="cancelOrder(this)">${order.is_cancelled ? 'Herstel' : 'Annuleer'}</button>
            <span class="notify"></span></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('totals').style.display = data.length ? '' : 'none';
document.getElementById('totalOmzet').textContent   = formatCurrency(total);
document.getElementById('btw9Amount').textContent   = formatCurrency(btw9Total);
document.getElementById('btw21Amount').textContent  = formatCurrency(btw21Total);
// ‚¨áÔ∏è Áªü‰∏ÄÊéßÂà∂ BTW Ë°åÊòæÁ§∫Ôºà9%/21% ÁöÑÊúâÂàôÊòæÔºåÊó†ÂàôÈöêÔºõBTW Totaal Ê∞∏ËøúÈöêËóèÔºâ
updateBTWDisplay(btw9Total, btw21Total);

document.getElementById('totalPin').textContent     = formatCurrency(pin);
document.getElementById('totalOrders').textContent  = orderCount;
document.getElementById('avgOrder').textContent     = formatCurrency(orderCount ? total / orderCount : 0);
document.getElementById('totalOnline').textContent  = formatCurrency(online);
document.getElementById('totalContant').textContent = formatCurrency(contant);
document.getElementById('totalCredit').textContent  = formatCurrency(credit);
document.getElementById('totalDiscount').textContent = formatCurrency(discountTotal);
document.getElementById('totalTip').textContent      = formatCurrency(tipTotal);
document.getElementById('totalDeposit').textContent  = formatCurrency(depositTotal);
document.getElementById('depositRow').style.display  = depositTotal > 0 ? '' : 'none';
document.getElementById('totalDelivery').textContent = `${formatCurrency(deliveryFeeTotal)} / ${deliveryCount}`;

const cancelledDisplay = `${cancelledCount} / ${formatCurrency(cancelled)}`;
document.getElementById('totalCancelled').textContent = cancelledDisplay;
      // Ëã•ÊÇ®Âú®HTML‰∏≠Ê∑ªÂä†‰∫Ü unknown Ë°åÔºå‰πüÂèØ‰ª•Êõ¥Êñ∞ÂÆÉÔºö
      const unknownEl = document.getElementById('totalUnknown');
      if (unknownEl) unknownEl.textContent = formatCurrency(unknown);
      applyThuisbezorgdTotals(mode, total, btw9Total, btw21Total, orderCount, depositTotal);
    })
    .catch(() => { alert('Fout bij het ophalen van gegevens.'); });
}

    function fetchOrders() {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, '0');
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const yy = now.getFullYear();
      currentQuery = { type: 'today', params: '' };
      loadOrders('/pos/orders_today?json=1', 'today', `${dd}-${mm}-${yy}`);
    }

    function fetchByDate() {
      const d = document.getElementById('datePicker').value;
      if (!d) return alert('Selecteer een datum.');
      currentQuery = { type: 'date', params: `date=${d}` };
      loadOrders(`/pos/orders_by_date?date=${d}&json=1`, 'date', d.split('-').reverse().join('-'));
    }

    function fetchByRange() {
      const s = document.getElementById('startDate').value;
      const e = document.getElementById('endDate').value;
      if (!s || !e) return alert('Selecteer zowel start- als einddatum.');
      currentQuery = { type: 'range', params: `start=${s}&end=${e}` };
      loadOrders(`/pos/orders_range?start=${s}&end=${e}&json=1`, 'range', `${s.split('-').reverse().join('-')} tot ${e.split('-').reverse().join('-')}`);
    }

    function downloadExcel() {
      window.open(`/admin/orders/download/excel?${currentQuery.params}`, "_blank");
    }

    function downloadPDF() {
      window.open(`/admin/orders/download/pdf?${currentQuery.params}`, "_blank");
    }

    function downloadOverviewPDF() {
      window.open(`/admin/orders/download/overview-pdf?${currentQuery.params}`, "_blank");
    }
    function applyThuisbezorgdTotals(mode, baseTotal, baseBtw9, baseBtw21, baseOrders, baseDeposit) {
      const url = new URL('/admin/thuisbezorgd', window.location.origin);
      const params = new URLSearchParams(currentQuery.params);
      if (mode === 'today') {
        const now = new Date();
        url.searchParams.set('date', now.toISOString().split('T')[0]);
      } else if (mode === 'date') {
        url.searchParams.set('date', params.get('date'));
      } else if (mode === 'range') {
        url.searchParams.set('start', params.get('start'));
        url.searchParams.set('end', params.get('end'));
      }

      fetch(url)
        .then(r => r.json())
        .then(tb => {
          document.getElementById('tbDisplay').style.display = '';
          document.getElementById('tbBtw9').textContent = formatCurrency(tb.btw9);
          document.getElementById('tbBtw21').textContent = formatCurrency(tb.btw21);
          document.getElementById('tbOmzet').textContent = formatCurrency(tb.totaal);
          document.getElementById('tbOrders').textContent = tb.orders || 0;
          document.getElementById('tbStatie').textContent = formatCurrency(tb.statiegeld);

          if (mode !== 'range') {
            document.getElementById('tbInput').style.display = '';
            document.getElementById('tbOmzetInput').value = tb.totaal || '';
            document.getElementById('tbBtw9Input').value = tb.btw9 || '';
            document.getElementById('tbBtw21Input').value = tb.btw21 || '';
            document.getElementById('tbOrdersInput').value = tb.orders || '';
            document.getElementById('tbStatieInput').value = tb.statiegeld || '';
          } else {
            document.getElementById('tbInput').style.display = 'none';
          }

          baseTotal += Number(tb.totaal || 0);
          baseBtw9 += Number(tb.btw9 || 0);
          baseBtw21 += Number(tb.btw21 || 0);
          baseOrders += Number(tb.orders || 0);
          baseDeposit += Number(tb.statiegeld || 0);
          document.getElementById('totalOmzet').textContent = formatCurrency(baseTotal);
          document.getElementById('btw9Amount').textContent = formatCurrency(baseBtw9);
          document.getElementById('btw21Amount').textContent = formatCurrency(baseBtw21);
          document.getElementById('totalOrders').textContent = baseOrders;
          document.getElementById('avgOrder').textContent = formatCurrency(baseOrders ? baseTotal / baseOrders : 0);
          document.getElementById('tbOverzichtTotal').textContent = formatCurrency(tb.totaal);
          document.getElementById('totalDeposit').textContent = formatCurrency(baseDeposit);
          document.getElementById('depositRow').style.display = baseDeposit > 0 ? '' : 'none';
          updateBTWDisplay(baseBtw9, baseBtw21);
        });
    }

    function saveThuisbezorgd() {
      const params = new URLSearchParams(currentQuery.params);
      let date;
      if (currentQuery.type === 'today') {
        const now = new Date();
        date = now.toISOString().split('T')[0];
      } else if (currentQuery.type === 'date') {
        date = params.get('date');
      } else {
        return alert('Selecteer een datum om op te slaan.');
      }

      const payload = {
        date: date,
        totaal: document.getElementById('tbOmzetInput').value,
        btw9: document.getElementById('tbBtw9Input').value,
        btw21: document.getElementById('tbBtw21Input').value,
        orders: document.getElementById('tbOrdersInput').value,
        statiegeld: document.getElementById('tbStatieInput').value
      };

      fetch('/admin/thuisbezorgd', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(r => r.json())
        .then(() => reloadCurrent())
        .catch(() => alert('Opslaan mislukt'));
    }

    function reloadCurrent() {
      if (currentQuery.type === 'today') fetchOrders();
      else if (currentQuery.type === 'date') fetchByDate();
      else if (currentQuery.type === 'range') fetchByRange();
    }
  function updateBTWDisplay(btw9, btw21) {
  const btw9Row = document.getElementById('btw9Amount')?.parentElement;   // <tr> of BTW 9%
  const btw21Row = document.getElementById('btw21Row');                   // <tr id="btw21Row">
  const btwTotalRow = document.getElementById('btwTotalAmount')?.parentElement; // BTW Totaal row

  // Ê∞∏ËøúÈöêËóè BTW Totaal
  if (btwTotalRow) btwTotalRow.style.display = 'none';
  
  
  // Ê†πÊçÆÊï∞ÂÄºÊòæÁ§∫/ÈöêËóè
  const show9  = Number(btw9)  > 0;
  const show21 = Number(btw21) > 0;

  if (btw9Row)  btw9Row.style.display  = show9  ? '' : 'none';
  if (btw21Row) btw21Row.style.display = show21 ? '' : 'none';
}

    function orderComplete(btn) {
      const status = btn.nextElementSibling;
      const payload = {
        order_number: btn.dataset.number,
        name: btn.dataset.name,
        phone: btn.dataset.phone,
        email: btn.dataset.email,
        order_type: btn.dataset.type
      };
      fetch('https://flask-order-api.onrender.com/api/order_complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(r => {
        status.textContent = r.ok ? 'Notificatie verzonden' : 'Notificatie mislukt';
      }).catch(() => {
        status.textContent = 'Notificatie mislukt';
      });
    }

    function toggleComplete(btn) {
      const tr = btn.closest('tr');
      const id = tr.dataset.id;
      const done = !tr.classList.contains('completed');
      fetch(`/api/orders/${id}/status`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({is_completed: done})
      }).then(r=>r.json()).then(() => {
        if(done) orderComplete(btn);
        reloadCurrent();
      });
    }

    function cancelOrder(btn) {
      const tr = btn.closest('tr');
      const id = tr.dataset.id;
      const cancelled = tr.classList.contains('cancelled');
      fetch(`/api/orders/${id}/status`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({is_cancelled: !cancelled})
      }).then(()=>reloadCurrent());
    }

    function parseItemsString(str, existing){
      const result={};
      if(!str) return result;
      str.split(',').forEach(part=>{
        const [name, qty] = part.split('=').map(s=>s.trim());
        const q = parseInt(qty,10);
        if(name && q>0){
          const price = existing && existing[name] ? existing[name].price : 0;
          result[name] = {qty: q, price};
        }
      });
      return result;
    }

    function setupEditDialog(){
      editDialog = document.getElementById('editDialog');
      editForm = document.getElementById('editForm');
      document.getElementById('editCancel').addEventListener('click', () => editDialog.close());
      editForm.addEventListener('submit', submitEdit);
    }

    function editOrder(btn) {
      const tr = btn.closest('tr');
      const id = tr.dataset.id;
      currentEditData = JSON.parse(tr.dataset.order || '{}');
      editForm.dataset.id = id;
      document.getElementById('editName').value = currentEditData.customer_name || '';
      document.getElementById('editPhone').value = currentEditData.phone || '';
      document.getElementById('editEmail').value = currentEditData.email || '';
      document.getElementById('editRemark').value = currentEditData.opmerking || currentEditData.remark || '';
      document.getElementById('editStreet').value = currentEditData.street || '';
      document.getElementById('editNumber').value = currentEditData.house_number || '';
      document.getElementById('editPostcode').value = currentEditData.postcode || '';
      document.getElementById('editCity').value = currentEditData.city || '';
      document.getElementById('editPickup').value = currentEditData.pickup_time || '';
      document.getElementById('editDelivery').value = currentEditData.delivery_time || '';
      const itemsStr = Object.entries(currentEditData.items || {}).map(([n,i])=>`${n}=${i.qty}`).join(', ');
      document.getElementById('editItems').value = itemsStr;
      document.getElementById('editPayment').value = currentEditData.payment_method || '';
      document.getElementById('editStatus').value = currentEditData.status || currentEditData.payment_status || '';
      document.getElementById('editTotaal').value = currentEditData.totaal != null ? currentEditData.totaal : '';
      document.getElementById('editBezorgkosten').value = currentEditData.bezorgkosten != null ? currentEditData.bezorgkosten : (currentEditData.delivery_fee || '');
      document.getElementById('editFooi').value = currentEditData.fooi != null ? currentEditData.fooi : (currentEditData.tip || '0');
      document.getElementById('editStatiegeld').value = currentEditData.statiegeld != null ? currentEditData.statiegeld : (currentEditData.deposit || '0');
      editDialog.showModal();
    }

    function submitEdit(e){
      e.preventDefault();
      const id = editForm.dataset.id;
      const payload = {
        customer_name: document.getElementById('editName').value,
        phone: document.getElementById('editPhone').value,
        email: document.getElementById('editEmail').value,
        opmerking: document.getElementById('editRemark').value,
        street: document.getElementById('editStreet').value,
        house_number: document.getElementById('editNumber').value,
        postcode: document.getElementById('editPostcode').value,
        city: document.getElementById('editCity').value,
        pickup_time: document.getElementById('editPickup').value,
        delivery_time: document.getElementById('editDelivery').value,
        items: parseItemsString(document.getElementById('editItems').value, currentEditData.items || {}),
        payment_method: document.getElementById('editPayment').value,
        status: document.getElementById('editStatus').value,
        totaal: parseFloat(document.getElementById('editTotaal').value) || 0,
        bezorgkosten: parseFloat(document.getElementById('editBezorgkosten').value) || 0,
        fooi: parseFloat(document.getElementById('editFooi').value) || 0,
        statiegeld: parseFloat(document.getElementById('editStatiegeld').value) || 0,
        order_type: currentEditData.order_type,
        bron: currentEditData.bron
      };
      fetch(`/api/orders/${id}`, {
        method:'PATCH',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(()=>{
        editDialog.close();
        reloadCurrent();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchOrders();
      document.getElementById('dateBtn').addEventListener('click', fetchByDate);
      document.getElementById('rangeBtn').addEventListener('click', fetchByRange);
      document.getElementById('excelBtn').addEventListener('click', downloadExcel);
      document.getElementById('pdfBtn').addEventListener('click', downloadPDF);
      document.getElementById('overviewPdfBtn').addEventListener('click', downloadOverviewPDF);
      document.getElementById('tbSaveBtn').addEventListener('click', saveThuisbezorgd);
      setupEditDialog();
    });
    </script>

</body>
</html>


<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dagelijkse Bestellingen</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
    th { background-color: #f2f2f2; }
    ul { margin: 0; padding-left: 20px; }
    #totals { margin-top: 20px; }
    #totals table { width: auto; margin-top: 10px; }
    .download-buttons { margin-bottom: 20px; }
    .download-buttons button {
      margin-right: 10px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    .completed { background-color: #c8e6c9; }
    .cancelled { background-color: #e0e0e0; }


    /* åŸºç¡€ */
.report { width:100%; border-collapse:collapse; font-size:0.95em; }
.report td, .report th { padding:0.4em 0.6em; border-bottom:1px solid #eee; }
.report th { text-align:left; font-size:0.85em; color:#666; background:#fafafa; }
.report tr.section th { border-top:1px solid #ddd; border-bottom:1px solid #ddd; }
.report td:first-child { text-align:left; }
.report td:last-child { text-align:right; font-weight:600; }
.report .emph td:last-child { font-weight:700; }
.report .warn td:last-child { color:#b00020; font-weight:700; }
@media (max-width:767px){ .report{font-size:0.9em;} .report td,.report th{padding:0.35em 0.5em;} }
/* æ‰€æœ‰é‡‘é¢åˆ—ç»Ÿä¸€å¼ºè°ƒ */
.money {
  text-align: right;
  font-weight: 700;   /* æ›´ç²— */
  color: #0b63b6;     /* ç»Ÿä¸€é¢œè‰²ï¼Œå¯æ¢æˆ #333 æ·±ç° æˆ– #006400 å¢¨ç»¿ */
  font-size: 1.05em;  /* å­—ä½“ç¨å¤§ */
}

/* ç‰¹åˆ«è­¦å‘Šè¡Œï¼ˆå·®é¢ï¼‰ */
.report .warn .money {
  color: #b00020;     /* çº¢è‰²å¼ºè°ƒ */
}

  </style>
</head>
<body>

  <h1 id="dayHeading">Vandaag</h1>

  <div style="margin-bottom:15px;">
    <label>Datum: <input type="date" id="datePicker"> <button id="dateBtn">Zoek</button></label>
    <label style="margin-left:20px;">Van: <input type="date" id="startDate"> Tot: <input type="date" id="endDate"> <button id="rangeBtn">Zoek</button></label>
  </div>

  <div class="download-buttons">
    <button id="excelBtn">ğŸ“¥ Download Excel</button>
    <button id="pdfBtn">ğŸ“„ Download PDF</button>
  </div>

  <div id="ordersContainer">
    <p id="noOrders" style="display:none;">Geen bestellingen gevonden.</p>
    <table id="ordersTable" style="display:none;">
      <thead>
        <tr>
          <th>ID</th>
          <th>Datum</th>
          <th>Orderd</th>
          <th>Tijdslot</th>
          <th>Type</th>
          <th>Klant</th>
          <th>Telefoon</th>
          <th>Email</th>
          <th>Items</th>
          <th>Opmerking</th>
          <th>Ordernummer</th>
          <th>Bezorgkosten (â‚¬)</th>
          <th>Fooi (â‚¬)</th>
          <th>Totaal (â‚¬)</th>
          <th>Adres</th>
          <th>Betaling</th>
          <th>Actie</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="totals" style="display:none;">
  <h2>Omzet Overzicht</h2>
  <table class="report">
  <!-- è®¢å•ä¿¡æ¯ -->
  <tr class="section"><th colspan="2">Bestellingen</th></tr>
  <tr><td>Aantal bestellingen</td><td id="totalOrders">0</td></tr>
  <tr id="cancelledRow"><td>Geannuleerd (aantal / bedrag)</td><td id="totalCancelled">0 / â‚¬0,00</td></tr>
  <tr><td>Gemiddelde bestelwaarde</td><td id="avgOrder">â‚¬0,00</td></tr>

  

  <!-- æŠ˜æ‰£ / å°è´¹ / é…é€è´¹ -->
  <tr class="section"><th colspan="2">Correcties & toeslagen</th></tr>
  <tr id="discountRow"><td>Totale korting</td><td id="totalDiscount">â‚¬0,00</td></tr>
  <tr id="tipRow"><td>Totale fooi</td><td id="totalTip">â‚¬0,00</td></tr>
  <tr id="deliveryRow"><td>Bezorgkosten (bedrag / aantal)</td><td id="totalDelivery">â‚¬0,00 / 0</td></tr>


  <!-- è¥ä¸šé¢ & ç¨ -->
<tr class="section"><th colspan="2">Omzet & btw</th></tr>
<tr class="emph"><td>Totale omzet (incl. btw)</td><td class="money" id="totalOmzet">â‚¬0,00</td></tr>
<tr id="btw9Row"><td>BTW 9%</td><td class="mone" id="btw9Amount">â‚¬0,00</td></tr>
<tr id="btw21Row"><td>BTW 21%</td><td class="mone" id="btw21Amount">â‚¬0,00</td></tr>
<tr id="btwTotalRow" style="display:none;"><td>BTW Totaal</td><td class="mone" id="btwTotalAmount">â‚¬0,00</td></tr>

<tr class="section"><th colspan="2">Betalingen</th></tr>
<tr id="contantRow"><td>Contant</td><td class="money" id="totalContant">â‚¬0,00</td></tr>
<tr id="pinRow"><td>Pin betaling</td><td class="money" id="totalPin">â‚¬0,00</td></tr>
<tr id="onlineRow"><td>Online betaling</td><td class="money" id="totalOnline">â‚¬0,00</td></tr>
<tr id="creditRow"><td>Op rekening</td><td class="money" id="totalCredit">â‚¬0,00</td></tr>
<tr class="emph"><td>Totaal ontvangen</td><td class="mone" id="totalReceived">â‚¬0,00</td></tr>
<tr class="warn" id="diffRow" style="display:none;"><td>Verschil / openstaand</td><td class="mone" id="totalDiff">â‚¬0,00</td></tr>


  <script>





    let currentQuery = { type: 'today', params: '' };

    function formatCurrency(value) {
      if (typeof value === 'string') {
        value = value.replace(/[^\d,.-]/g, '').replace(',', '.').trim();
      }
      const num = parseFloat(value);
      return isNaN(num) ? 'â‚¬0,00' : 'â‚¬' + num.toFixed(2).replace('.', ',');
    }

    function loadOrders(url, mode = 'today', label = '') {
  fetch(url)
    .then(r => r.json())
    .then(data => {
      const tbody = document.querySelector('#ordersTable tbody');
      const table = document.getElementById('ordersTable');
      const msg = document.getElementById('noOrders');
      tbody.innerHTML = '';

      // åˆå§‹åŒ–ç»Ÿè®¡æ•°æ®
      let total = 0, pin = 0, online = 0, contant = 0, credit = 0, unknown = 0;
      let cancelled = 0, cancelledCount = 0;
      let tipTotal = 0, discountTotal = 0;
      let deliveryFeeTotal = 0, deliveryCount = 0;
      let orderCount = 0;
      let btw9Total = 0, btw21Total = 0;
      // æ˜¾ç¤ºæˆ–éšè—è®¢å•è¡¨æ ¼
      if (data.length) {
        table.style.display = '';
        msg.style.display = 'none';
      } else {
        table.style.display = 'none';
        msg.style.display = 'block';
      }

      // è®¾ç½®æ ‡é¢˜
      const heading = document.getElementById('dayHeading');
      if (mode === 'today') {
        heading.textContent = `Vandaag â€“ ${label}`;
      } else if (mode === 'date') {
        heading.textContent = `Bestellingen van ${label}`;
      } else if (mode === 'range') {
        heading.textContent = `Bestellingen van ${label}`;
      }

      // æ”¯ä»˜æ–¹å¼æ˜ å°„å‡½æ•°
      function normalizePaymentMethod(methodRaw) {
        const method = String(methodRaw || '').toLowerCase();
        if (['pin', 'card'].some(k => method.includes(k))) return 'pin';
        if (['online', 'online payment'].some(k => method.includes(k))) return 'online';
        if (['contant', 'cash'].some(k => method.includes(k))) return 'contant';
        if (['rekening', 'on account'].some(k => method.includes(k))) return 'rekening';
        return 'onbekend';
      }

      // æ¸²æŸ“æ¯ä¸€è¡Œè®¢å•
      data.forEach(order => {
        const tr = document.createElement('tr');
        tr.dataset.id = order.id;
        tr.dataset.order = JSON.stringify(order);
        if (order.is_cancelled) tr.classList.add('cancelled');
        else if (order.is_completed) tr.classList.add('completed');

        const isDelivery = ['delivery', 'bezorgen'].includes((order.order_type || '').toLowerCase());
        const items = Object.entries(order.items || {}).map(([n, i]) => `<li>${n} x ${i.qty}</li>`).join('');

        let fooi = parseFloat(order.fooi ?? order.tip ?? 0);
        if (isNaN(fooi)) fooi = 0;

        let tot = order.totaal ?? order.total ?? 0;
        if (typeof tot === 'string') {
          tot = parseFloat(tot.replace(/[^\d,.-]/g, '').replace(',', '.'));
        }

        const delFee = Number(order.delivery_fee ?? order.bezorgkosten ?? 0);

        if (order.is_cancelled) {
          cancelled += tot || 0;
          cancelledCount++;
        } else {
          total += tot;
          tipTotal += fooi;
          discountTotal += Number(order.discountAmount ?? order.korting ?? 0);
          deliveryFeeTotal += delFee;
          if (isDelivery) deliveryCount++;
          orderCount++;
          btw9Total += Number(order.btw_9 || 0);
          btw21Total += Number(order.btw_21 || 0);
          const norm = normalizePaymentMethod(order.payment_method);
          if (norm === 'pin') pin += tot;
          else if (norm === 'online') online += tot;
          else if (norm === 'contant') contant += tot;
          else if (norm === 'rekening') credit += tot;
          else unknown += tot;
        }

        tr.innerHTML = `
          <td>${order.id || ''}</td>
          <td>${order.created_date || ''}</td>
          <td>${order.created_at || ''}</td>
          <td>${isDelivery ? (order.delivery_time || order.deliveryTime || '-') : (order.pickup_time || order.pickupTime || '-')}</td>
          <td>${isDelivery ? 'Bezorgen' : 'Afhalen'}</td>
          <td>${order.customer_name || ''}</td>
          <td>${order.phone || ''}</td>
          <td>${order.email || '-'}</td>
          <td><ul>${items}</ul></td>
          <td>${order.opmerking || order.remark || '-'}</td>
          <td>${order.order_number || ''}</td>
          <td>${isDelivery ? formatCurrency(delFee) : '-'}</td>
          <td>${formatCurrency(fooi)}</td>
          <td>${formatCurrency(tot)}</td>
          <td>${isDelivery ? `${order.street} ${order.house_number} ${order.postcode} ${order.city}${order.maps_link ? ` <a href="${order.maps_link}" target="_blank">ğŸ“Maps</a>` : ''}` : '-'}</td>
          <td>${order.payment_method || ''}</td>
          <td><button onclick="toggleComplete(this)"
            data-number="${order.order_number}"
            data-name="${order.customer_name || ''}"
            data-phone="${order.phone || ''}"
            data-email="${order.email || ''}"
            data-type="${isDelivery ? 'bezorg' : 'afhaal'}">${order.is_completed ? 'Undone' : 'Klaar'}</button>
            <button onclick="editOrder(this)">Bewerk</button>
            <button onclick="cancelOrder(this)">Annuleer</button>
            <span class="notify"></span></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('totals').style.display = data.length ? '' : 'none';
document.getElementById('totalOmzet').textContent   = formatCurrency(total);
document.getElementById('btw9Amount').textContent   = formatCurrency(btw9Total);
document.getElementById('btw21Amount').textContent  = formatCurrency(btw21Total);
// â¬‡ï¸ ç»Ÿä¸€æ§åˆ¶ BTW è¡Œæ˜¾ç¤ºï¼ˆ9%/21% çš„æœ‰åˆ™æ˜¾ï¼Œæ— åˆ™éšï¼›BTW Totaal æ°¸è¿œéšè—ï¼‰
updateBTWDisplay(btw9Total, btw21Total);

document.getElementById('totalPin').textContent     = formatCurrency(pin);
document.getElementById('totalOrders').textContent  = orderCount;
document.getElementById('avgOrder').textContent     = formatCurrency(orderCount ? total / orderCount : 0);
document.getElementById('totalOnline').textContent  = formatCurrency(online);
document.getElementById('totalContant').textContent = formatCurrency(contant);
document.getElementById('totalCredit').textContent  = formatCurrency(credit);
document.getElementById('totalDiscount').textContent = formatCurrency(discountTotal);
document.getElementById('totalTip').textContent      = formatCurrency(tipTotal);
document.getElementById('totalDelivery').textContent = `${formatCurrency(deliveryFeeTotal)} / ${deliveryCount}`;

const cancelledDisplay = `${cancelledCount} / ${formatCurrency(cancelled)}`;
document.getElementById('totalCancelled').textContent = cancelledDisplay;
      // è‹¥æ‚¨åœ¨HTMLä¸­æ·»åŠ äº† unknown è¡Œï¼Œä¹Ÿå¯ä»¥æ›´æ–°å®ƒï¼š
      const unknownEl = document.getElementById('totalUnknown');
      if (unknownEl) unknownEl.textContent = formatCurrency(unknown);
    })
    .catch(() => { alert('Fout bij het ophalen van gegevens.'); });
}

    function fetchOrders() {
      const now = new Date();
      const dd = String(now.getDate()).padStart(2, '0');
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const yy = now.getFullYear();
      currentQuery = { type: 'today', params: '' };
      loadOrders('/pos/orders_today?json=1', 'today', `${dd}-${mm}-${yy}`);
    }

    function fetchByDate() {
      const d = document.getElementById('datePicker').value;
      if (!d) return alert('Selecteer een datum.');
      currentQuery = { type: 'date', params: `date=${d}` };
      loadOrders(`/pos/orders_by_date?date=${d}&json=1`, 'date', d.split('-').reverse().join('-'));
    }

    function fetchByRange() {
      const s = document.getElementById('startDate').value;
      const e = document.getElementById('endDate').value;
      if (!s || !e) return alert('Selecteer zowel start- als einddatum.');
      currentQuery = { type: 'range', params: `start=${s}&end=${e}` };
      loadOrders(`/pos/orders_range?start=${s}&end=${e}&json=1`, 'range', `${s.split('-').reverse().join('-')} tot ${e.split('-').reverse().join('-')}`);
    }

    function downloadExcel() {
      window.open(`/admin/orders/download/excel?${currentQuery.params}`, "_blank");
    }

    function downloadPDF() {
      window.open(`/admin/orders/download/pdf?${currentQuery.params}`, "_blank");
    }
    function updateBTWDisplay(btw9, btw21) {
  const btw9Row = document.getElementById('btw9Amount')?.parentElement;   // <tr> of BTW 9%
  const btw21Row = document.getElementById('btw21Row');                   // <tr id="btw21Row">
  const btwTotalRow = document.getElementById('btwTotalAmount')?.parentElement; // BTW Totaal row

  // æ°¸è¿œéšè— BTW Totaal
  if (btwTotalRow) btwTotalRow.style.display = 'none';
  
  
  // æ ¹æ®æ•°å€¼æ˜¾ç¤º/éšè—
  const show9  = Number(btw9)  > 0;
  const show21 = Number(btw21) > 0;

  if (btw9Row)  btw9Row.style.display  = show9  ? '' : 'none';
  if (btw21Row) btw21Row.style.display = show21 ? '' : 'none';
}

    document.addEventListener('DOMContentLoaded', fetchOrders);
    document.getElementById('dateBtn').addEventListener('click', fetchByDate);
    document.getElementById('rangeBtn').addEventListener('click', fetchByRange);
    document.getElementById('excelBtn').addEventListener('click', downloadExcel);
    document.getElementById('pdfBtn').addEventListener('click', downloadPDF);



    
  </script>

  <script>
const fmtEUR = n => (n==null ? 'â‚¬0,00' : n.toLocaleString('nl-NL',{style:'currency',currency:'EUR'}));
const setTxt  = (id, v) => document.getElementById(id).textContent = v;
const showRow = id => document.getElementById(id).style.display = 'table-row';
const hideRow = id => document.getElementById(id).style.display = 'none';

/**
 * ä¼ å…¥ä¸€ä¸ªæ•°æ®å¯¹è±¡ dï¼š
 * d.totalOmzet  å«ç¨æ€»é¢
 * d.contant / d.pin / d.online / d.credit  å„æ”¯ä»˜æ–¹å¼
 * å¯é€‰ï¼šd.cancelledAmountï¼ˆå–æ¶ˆæ€»é¢ï¼‰ã€d.refundAmountï¼ˆé€€æ¬¾ï¼‰ã€d.pendingOnlineï¼ˆå¾…å…¥è´¦çš„åœ¨çº¿æ”¯ä»˜ï¼‰ã€
 *      d.rounding (å››èˆäº”å…¥è°ƒæ•´ï¼Œæ­£è´Ÿçš†å¯)ã€d.discount (æŠ˜æ‰£)ã€d.tip (å°è´¹)
 */
function validateTotals(d){
  const omzet = +(d.totalOmzet||0);
  const received = +(d.contant||0) + +(d.pin||0) + +(d.online||0) + +(d.credit||0);

  setTxt('totalReceived', fmtEUR(received));

  const diff = +(omzet - received);
  const eps  = 0.02; // å…è®¸çš„â€œæ‰¾é›¶/å››èˆäº”å…¥â€è¯¯å·®é˜ˆå€¼ï¼ˆ2æ¬§åˆ†ï¼‰

  if (Math.abs(diff) <= eps) {
    hideRow('diffRow'); hideRow('diffReasonRow');
    return;
  }

  setTxt('totalDiff', fmtEUR(diff));
  showRow('diffRow');

  // â€”â€” æ™ºèƒ½åŸå› æ¨æ–­ â€”â€” //
  const reasons = [];

  // 1) æœªç»“æ¸…çš„â€œOp rekeningâ€
  if ((d.credit||0) > 0 && diff > eps) {
    reasons.push('å­˜åœ¨æœªç»“æ¸…çš„â€œOp rekeningâ€ï¼ˆèµŠè´¦æœªæ”¶æ¬¾ï¼‰ã€‚');
  }

  // 2) åœ¨çº¿æ”¯ä»˜æŒ‚èµ·/å»¶è¿Ÿå…¥è´¦
  if ((d.pendingOnline||0) > 0 && diff > eps) {
    reasons.push('æœ‰å¾…å…¥è´¦çš„ Online betalingï¼ˆæ”¯ä»˜é€šé“å°šæœªå›è°ƒï¼‰ã€‚');
  }

  // 3) å–æ¶ˆ/é€€æ¬¾å¯¼è‡´å·®é¢
  if ((d.cancelledAmount||0) > 0 || (d.refundAmount||0) > 0) {
    reasons.push('æœ‰å–æ¶ˆ/é€€æ¬¾è®°å½•ï¼Œå¯èƒ½æœªåŒæ­¥åˆ°æ”¶æ¬¾ç»Ÿè®¡ã€‚');
  }

  // 4) å››èˆäº”å…¥æˆ–æŠ¹é›¶å·®å¼‚
  if (Math.abs(d.rounding||0) > 0) {
    reasons.push('å­˜åœ¨å››èˆäº”å…¥/æŠ¹é›¶è°ƒæ•´ï¼ˆroundingï¼‰ã€‚');
  } else if (Math.abs(diff) < 0.10) {
    reasons.push('å¯èƒ½æ˜¯å°é¢å››èˆäº”å…¥å·®å¼‚ï¼Œè¯·æ ¸å¯¹å•ç¬”é‡‘é¢å’Œç¨é¢è®¡ç®—ã€‚');
  }

  // 5) æŠ˜æ‰£/å°è´¹æœªä¸€è‡´è®¡å…¥
  if ((d.discount||0) !== 0) {
    reasons.push('æŠ˜æ‰£å·²å½±å“ Omzetï¼Œè¯·ç¡®è®¤æ˜¯å¦åŒæ­¥å½±å“åˆ°æ”¶æ¬¾ç«¯ã€‚');
  }
  if ((d.tip||0) !== 0) {
    reasons.push('å°è´¹(Tip)è®¡å…¥å·®å¼‚ï¼Œè¯·ç¡®è®¤æ˜¯å¦è®¡å…¥ Omzet æˆ–å•ç‹¬å…¥è´¦ã€‚');
  }

  // 6) ç¨ç‡åˆ†é…æˆ–æ—¶é—´è·¨æ—¥
  if ((d.btw9||0) > 0 || (d.btw21||0) > 0) {
    reasons.push('æ ¸å¯¹ BTW 9%/21% çš„åˆ†é…ä¸å«ç¨è®¡ç®—æ˜¯å¦ä¸æ”¶æ¬¾ä¾§ä¸€è‡´ã€‚');
  }
  reasons.push('å¦‚æœ‰è·¨æ—¥ç»“ç®—æˆ–æ‰‹å·¥æ”¹ä»·ï¼Œè¯·æ ¸å¯¹è®¢å•æ—¶é—´å’Œå¯¹è´¦æ‰¹æ¬¡ã€‚');

  document.getElementById('diffReason').textContent = 'å¯èƒ½åŸå› ï¼š' + reasons.join(' ');
  showRow('diffReasonRow');
}

// â€”â€” ç¤ºä¾‹è°ƒç”¨ â€”â€”
// validateTotals({
//   totalOmzet: 70.40,
//   contant: 70.40,
//   pin: 0, online: 0, credit: 0,
//   // ä¸‹é¢è¿™äº›æ˜¯å¯é€‰é¡¹ï¼Œä¸éœ€è¦å°±ä¸ä¼ 
//   cancelledAmount: 0,
//   refundAmount: 0,
//   pendingOnline: 0,
//   rounding: 0,
//   discount: 3.00,
//   tip: 0,
//   btw9: 6.34, btw21: 0
// });
</script>

</body>
</html>

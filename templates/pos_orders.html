<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bestellingen Vandaag</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    ul { margin: 0; padding-left: 20px; }
  </style>
</head>
<body>
  <h1>Bestellingen Vandaag</h1>
  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>Tijd</th>
        <th>Type</th>
        <th>Klant</th>
        <th>Telefoon</th>
        <th>Email</th>
        <th>Items</th>
        <th>Opmerking</th>
        <th>Subtotaal (&euro;)</th>
        <th>Totaal (&euro;)</th>
        <th>Adres</th>
        <th>Tijdslot</th>
        <th>Betaling</th>
      </tr>
    </thead>
    <tbody>
    {% for order in orders %}
      <tr>
        <td>{{ order.created_at_local.strftime('%Y-%m-%d') }}</td>
        <td>{{ order.created_at_local.strftime('%H:%M') }}</td>
        {% set is_delivery = order.order_type in ['delivery', 'bezorgen'] %}
        <td>{{ 'Bezorgen' if is_delivery else 'Afhalen' }}</td>
        <td>{{ order.customer_name or '' }}</td>
        <td>{{ order.phone or '' }}</td>
        <td>{{ order.email or '-' }}</td>
        <td>
          <ul>
          {% for name, item in order.items_dict.items() %}
            <li>{{ name }} x {{ item['qty'] }}</li>
          {% endfor %}
          </ul>
        </td>
        <td>{{ order.opmerking or '-' }}</td>
        {% set sub_val = order.subtotal if order.subtotal is defined else order.total %}
        <td>{{ '%.2f' % sub_val }}</td>
        {% set tot_val = order.totaal if order.totaal is defined else sub_val %}
        <td>{{ '%.2f' % tot_val }}</td>
        <td>
          {% if is_delivery %}
            {{ order.street }} {{ order.house_number }} {{ order.postcode }} {{ order.city }}
            {% if order.maps_link %}
              <a href="{{ order.maps_link }}" target="_blank">üìçMaps</a>
            {% endif %}
          {% else %}-{% endif %}
        </td>
        <td>
          {% if is_delivery %}
            {{ order.delivery_time or '-' }}
          {% else %}
            {{ order.pickup_time or '-' }}
          {% endif %}
        </td>
        <td>{{ order.payment_method }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
  <p><a href="{{ url_for('pos') }}">Terug naar POS</a></p>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const socket = io({transports:['websocket']});
    let pollTimer;

    function parseEuro(val){
      if(val===undefined||val===null) return NaN;
      if(typeof val==='string'){
        val = val.replace(/[^0-9,.-]/g,'').replace(',','.');
      }
      return parseFloat(val);
    }
    window.addEventListener('beforeunload',()=>socket.disconnect());
    socket.on('connect_error',()=>{setTimeout(()=>socket.connect(),1000);});
    socket.on('disconnect', startPolling);
    socket.on('connect', stopPolling);
    function addRow(order){
      const tbody = document.querySelector('table tbody');
      const tr = document.createElement('tr');
      const isDelivery = ['delivery','bezorgen'].includes(order.order_type);
      const items = Object.entries(order.items || {}).map(([n,i]) => `<li>${n} x ${i.qty}</li>`).join('');
      let subtotal = parseEuro(order.subtotal);
      if(isNaN(subtotal)){
        subtotal = Object.values(order.items || {}).reduce((s,i)=>s + (parseEuro(i.price)*parseInt(i.qty||0)),0);
      }
      let total = parseEuro(order.totaal);
      if(isNaN(total)){
        total = parseEuro(order.total);
      }
      if(isNaN(total)){
        total = subtotal;
      }
      const remark = order.opmerking || order.remark || '';
      const pickup = order.pickup_time || order.pickupTime;
      const delivery = order.delivery_time || order.deliveryTime;
      tr.innerHTML = `
        <td>${order.created_date || ''}</td>
        <td>${order.created_at || ''}</td>
        <td>${isDelivery ? 'Bezorgen' : 'Afhalen'}</td>
        <td>${order.customer_name || ''}</td>
        <td>${order.phone || ''}</td>
        <td>${order.email || '-'}</td>
        <td><ul>${items}</ul></td>
        <td>${remark || '-'}</td>
        <td>${subtotal.toFixed(2)}</td>
        <td>${total.toFixed(2)}</td>
        <td>${isDelivery ? `${order.street} ${order.house_number} ${order.postcode} ${order.city}${order.maps_link ? ` <a href="${order.maps_link}" target="_blank">üìçMaps</a>` : ''}` : '-'}</td>
        <td>${isDelivery ? (delivery || '-') : (pickup || '-')}</td>
        <td>${order.payment_method || ''}</td>`;
      tbody.prepend(tr);
    }
    socket.on('new_order', addRow);

    function fetchOrders(){
      fetch('/pos/orders_today?json=1').then(r=>r.json()).then(data=>{
        const tbody = document.querySelector('table tbody');
        if(!tbody) return;
        tbody.innerHTML='';
        data.forEach(addRow);
      }).catch(()=>{});
    }

    function startPolling(){
      if(pollTimer) return;
      fetchOrders();
      pollTimer = setInterval(fetchOrders,10000);
    }

    function stopPolling(){
      if(pollTimer){
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }
  </script>
</body>
</html>

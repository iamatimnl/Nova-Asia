<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>POS Interface</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    padding: 20px;
    max-width: 1200px;
    margin: auto;
    background: var(--primary-color);
    color: var(--secondary-color);
    padding-top: 60px;
    text-align: center;
  }

  :root {
    --primary-color: #f2e9d8;
    --secondary-color: #333333;
    --accent-color: #3f5c4b;
    --off-white: #faf8f3;
    --section-alt-bg: #f0e6d7;
    --sakura: #f6d4dc;
    --gold: #c5a253;
  }
  .navbar-container::-webkit-scrollbar { display: none; }
  .navbar-container {
    -ms-overflow-style: none;
    scrollbar-width: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    padding: 0;
    margin: 0;
    background-color: var(--off-white);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-bottom: 1px solid #ccc;
    z-index: 999;
  }
  .navbar {
    display: flex;
    flex-direction: row;
    white-space: nowrap;
    position: relative;
    width: 100vw;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    scroll-behavior: auto;
  }
  .nav-categories { display: flex; white-space: nowrap; }
  @media (min-width: 768px) { .nav-categories { margin: 0 auto; } }
  .navbar a {
    flex: 0 0 auto;
    padding: 14px 20px;
    color: var(--accent-color);
    text-decoration: none;
    font-weight: bold;
    border-radius: 24px;
    transition: all 0.3s ease;
    position: relative;
    z-index: 2;
  }
  .navbar a.active { color: white; }
  .indicator {
    position: absolute;
    height: 32px;
    background-color: var(--accent-color);
    border-radius: 24px;
    bottom: 8px;
    z-index: 1;
    transition: all 0.3s ease;
    will-change: transform;
  }
  .navbar::after { content: ""; flex: 0 0 50vw; }
  section {
    padding: 40px 20px;
    box-sizing: border-box;
    border-bottom: 1px solid #ccc;
    border-radius: 16px;
    background: var(--off-white);
    margin-bottom: 20px;
  }
  section:nth-child(even) { background: var(--section-alt-bg); }
  h1,h2,h3,h4,h5,h6,p { text-align: center; }
  .menu-item {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
    padding: 16px;
    margin-bottom: 12px;
    border-radius: 16px;
    background: var(--off-white);
    border: 1px solid #e0e0e0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  img { max-width: 100%; height: auto; }
  .menu-item img { width: 100%; max-width: 120px; height: auto; object-fit: cover; border-radius: 12px; flex-shrink: 0; }
  .menu-item select, .menu-item button {
    margin-top: 8px;
    padding: 6px 8px;
    font-size: 0.85rem;
    height: 36px;
    border-radius: 10px;
    border: 1px solid #ccc;
  }
  .menu-item button {
    width: 2.2rem;
    height: 2.2rem;
    font-size: 1rem;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    border: none;
    transition: background 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .add-button { background: var(--accent-color); color: white; }
  .remove-button { background: var(--sakura); color: white; }
  @media (max-width: 600px) {
    .menu-item button { width:1.8rem; height:1.8rem; font-size:0.9rem; }
    .menu-item img { max-width:80px; }
  }
  @media (max-width: 600px) { .menu-item { flex-direction: column; align-items: flex-start; } }
  .pos-container { display: flex; flex-direction: column; }
  .left-panel { display:flex; flex-direction: column; flex:2; }
  .orders-panel { margin-top:20px; }
  .orders-panel table { width:100%; border-collapse: collapse; }
  .orders-panel th, .orders-panel td { border:1px solid #ddd; padding:8px; text-align:left; }
  .orders-panel th { background:#f2f2f2; }
  .orders-panel ul { margin:0; padding-left:20px; }
  .order-summary {
    background: var(--off-white);
    border: 1px solid #e0e0e0;
    border-radius: 16px;
    padding: 20px;
    margin-top: 20px;
  }
  @media (min-width: 768px) {
    .pos-container { flex-direction: row; align-items: flex-start; }
    .left-panel { flex-direction: row; flex:2; }
    .product-list { flex:2; margin-right:20px; }
    .order-summary { width:300px; margin-right:20px; margin-top:0; }
    .orders-panel { flex:1; max-width:400px; }
  }
  .order-summary button {
    width:100%;
    margin-top:10px;
    padding:12px;
    font-size:1.1rem;
    background: var(--accent-color);
    color:white;
    border:none;
    border-radius:12px;
  }
  .hidden { display:none; }
</style>
</head>
<body>
<div class="navbar-container" id="navbar-container">
  <nav class="navbar" id="navbar">
    <div class="nav-categories">
      <a href="#customer-info">Klant</a>
      <a href="#bento">Bento Box</a>
      <a href="#sushi">Sushi Rolls</a>
      <a href="#bubble">Bubble Tea</a>
      <a href="#dessert">Dessert</a>
      <a href="#snack">Snack</a>
      <a href="#vegan">Vegan</a>
    </div>
    <div class="indicator" id="indicator"></div>
  </nav>
</div>
<h1>Bestelling</h1>
<div class="pos-container">
  <div class="left-panel">
    <div class="product-list">
    <section id="customer-info">
      <div class="delivery-options">
        <h2>Klantgegevens</h2>
        <label for="custName">Naam*</label>
        <input id="custName" type="text" required />
        <label for="custPhone">Telefoonnummer*</label>
        <input id="custPhone" type="tel" required />
        <div style="margin-top:10px;">
          <input type="radio" id="typePickup" name="orderType" value="pickup" checked />
          <label for="typePickup">Pickup</label>
          <input type="radio" id="typeDelivery" name="orderType" value="delivery" style="margin-left:20px;" />
          <label for="typeDelivery">Delivery</label>
        </div>
        <div id="pickupFields" style="margin-top:10px;">
          <label for="pickupTime">Pickup Tijd*</label>
          <input id="pickupTime" type="time" />
          <label for="pickupPayment">Betaalmethode*</label>
          <select id="pickupPayment">
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="paid">Already Paid</option>
          </select>
        </div>
        <div id="deliveryFields" class="hidden" style="margin-top:10px;">
          <label for="postcode">Postcode*</label>
          <input id="postcode" type="text" />
          <label for="houseNumber">Huisnummer*</label>
          <input id="houseNumber" type="text" />
          <label for="street">Straat*</label>
          <input id="street" type="text" readonly />
          <label for="city">Plaats*</label>
          <input id="city" type="text" readonly />
          <label for="deliveryTime">Bezorgtijd (optioneel)</label>
          <input id="deliveryTime" type="time" />
          <label for="deliveryPayment">Betaalmethode*</label>
          <select id="deliveryPayment">
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="paid">Already Paid</option>
          </select>
        </div>
        <div id="qrCodeContainer" class="hidden" style="text-align:center;margin-top:10px;">
          <p><strong>üìç Scan voor navigatie:</strong></p>
          <img id="qrCodePreview" src="" alt="QR Code" />
        </div>
      </div>
    </section>
    {% include 'menu.html' %}
  </div>
  <div class="order-summary">
    <h2>Overzicht</h2>
    <ul id="cart"></ul>
    <div class="total">Totaal: ‚Ç¨<span id="total">0.00</span></div>
    <button id="submitOrder">Submit Order</button>
  </div>
  </div>
  <div class="orders-panel">
    {% include 'orders_table.html' %}
  </div>
</div>
<audio id="notifySound" src="/sound/beep.mp3" preload="auto"></audio>

<script>
const cart = {};
function populateSelect(sel){
  for(let i=0;i<=20;i++){ const opt=document.createElement('option'); opt.value=i; opt.textContent=i; sel.appendChild(opt); }
}
function createSelect(current,onChange){
  const sel=document.createElement('select');
  for(let i=0;i<=20;i++){ const opt=document.createElement('option'); opt.value=i; opt.textContent=i; if(i===current) opt.selected=true; sel.appendChild(opt); }
  sel.addEventListener('change',()=>onChange(parseInt(sel.value))); return sel;
}
function setQty(name,price,qty){ if(qty===0){ delete cart[name]; } else { cart[name]={price,qty}; } updateCart(); }
function updateCart(){
  const list=document.getElementById('cart');
  list.innerHTML='';
  let total=0;
  Object.entries(cart).forEach(([name,item])=>{
    const li=document.createElement('li');
    const sel=createSelect(item.qty,val=>{ document.querySelector(`[data-name="${name}"] select`).value=val; setQty(name,item.price,val); });
    const subtotal=item.qty*item.price;
    li.textContent=`${name} = ‚Ç¨${subtotal.toFixed(2)} `;
    li.appendChild(sel);
    list.appendChild(li);
    if(item.qty>0) total+=subtotal;
  });
  document.getElementById('total').textContent=total.toFixed(2);
}

document.addEventListener('DOMContentLoaded',()=>{
  document.querySelectorAll('.menu-item select').forEach(sel=>{
    populateSelect(sel);
    const parent=sel.closest('.menu-item');
    const name=parent.dataset.name;
    const price=parseFloat(parent.dataset.price);
    sel.addEventListener('change',()=>{ setQty(name,price,parseInt(sel.value)); });
  });
  document.querySelectorAll('.qty-plus').forEach(btn=>{
    btn.addEventListener('click',()=>{ const sel=document.getElementById(btn.dataset.target); let val=parseInt(sel.value); if(val<20) val++; sel.value=val; const parent=sel.closest('.menu-item'); setQty(parent.dataset.name,parseFloat(parent.dataset.price),val); });
  });
  document.querySelectorAll('.qty-minus').forEach(btn=>{
    btn.addEventListener('click',()=>{ const sel=document.getElementById(btn.dataset.target); let val=parseInt(sel.value); if(val>0) val--; sel.value=val; const parent=sel.closest('.menu-item'); setQty(parent.dataset.name,parseFloat(parent.dataset.price),val); });
  });
  document.getElementById('typePickup').addEventListener('change',toggleAddress);
  document.getElementById('typeDelivery').addEventListener('change',toggleAddress);
  document.getElementById('postcode').addEventListener('blur',fetchAddress);
  document.getElementById('houseNumber').addEventListener('blur',fetchAddress);
  document.getElementById('postcode').addEventListener('blur',updateQRCode);
  document.getElementById('houseNumber').addEventListener('blur',updateQRCode);
  document.getElementById('street').addEventListener('blur',updateQRCode);
  document.getElementById('city').addEventListener('blur',updateQRCode);
  document.getElementById('submitOrder').addEventListener('click',submitOrder);
  updateCart();
  toggleAddress();
});
function toggleAddress(){
  const delivery=document.getElementById('typeDelivery').checked;
  document.getElementById('pickupFields').classList.toggle('hidden',delivery);
  document.getElementById('deliveryFields').classList.toggle('hidden',!delivery);
  document.getElementById('pickupTime').required=!delivery?true:false;
  document.getElementById('pickupPayment').required=!delivery?true:false;
  document.getElementById('postcode').required=delivery;
  document.getElementById('houseNumber').required=delivery;
  document.getElementById('deliveryPayment').required=delivery;
  if(!delivery){
    document.getElementById('qrCodeContainer').classList.add('hidden');
  } else {
    updateQRCode();
  }
}
async function fetchAddress(){
  const pc=document.getElementById('postcode').value.trim();
  const num=document.getElementById('houseNumber').value.trim();
  if(pc && num){
    const url=`https://api.postcodeapi.nu/v3/lookup/${encodeURIComponent(pc)}/${encodeURIComponent(num)}`;
    try{
      const res=await fetch(url,{headers:{'X-Api-Key':'juW6MEgEeL2BEM0rInEtB5a15BqXjWwO3YqrdH0z'}});
      if(res.ok){
        const d=await res.json();
        if(d.street) document.getElementById('street').value=d.street;
        if(d.city) document.getElementById('city').value=d.city;
      }
    }catch(e){console.warn('Adres ophalen mislukt');}
    updateQRCode();
  }
}
function updateQRCode(){
  const street=document.getElementById('street').value.trim();
  const house=document.getElementById('houseNumber').value.trim();
  const pc=document.getElementById('postcode').value.trim();
  const city=document.getElementById('city').value.trim();
  const container=document.getElementById('qrCodeContainer');
  const img=document.getElementById('qrCodePreview');
  if(street && house && pc && city){
    const address=`${street} ${house}, ${pc} ${city}`;
    const googleMapsLink=`https://www.google.com/maps?q=${encodeURIComponent(address)}`;
    const qrCodeUrl=`https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(googleMapsLink)}`;
    img.src=qrCodeUrl;
    container.classList.remove('hidden');
  }else{
    img.src='';
    container.classList.add('hidden');
  }
}
function submitOrder() {
  const name = document.getElementById('custName').value.trim();
  const phone = document.getElementById('custPhone').value.trim();
  if (!name || !phone) {
    alert('Vul naam en telefoon in.');
    return;
  }

  const delivery = document.getElementById('typeDelivery').checked;

  if (!delivery) {
    if (!document.getElementById('pickupTime').value) {
      alert('Pickup tijd is verplicht.');
      return;
    }
  } else {
    if (
      !document.getElementById('postcode').value ||
      !document.getElementById('houseNumber').value ||
      !document.getElementById('street').value ||
      !document.getElementById('city').value
    ) {
      alert('Adresgegevens zijn verplicht.');
      return;
    }
  }

  if (Object.keys(cart).length === 0) {
    alert('Geen producten geselecteerd.');
    return;
  }

  // üßæ Ëá™Âä®ÁîüÊàêËÆ¢ÂçïÊñáÂ≠óÔºàmessageÔºâ
  const orderText = Object.entries(cart).map(([name, item]) => {
    return `${name} x ${item.qty} (‚Ç¨${(item.qty * item.price).toFixed(2)})`;
  }).join(', ');

  // ‚úèÔ∏è Â§áÊ≥®‰ø°ÊÅØÔºàremarkÔºâ
  const remark = delivery
    ? `${document.getElementById('street').value} ${document.getElementById('houseNumber').value}, ${document.getElementById('postcode').value} ${document.getElementById('city').value}`
    : `Afhalen om ${document.getElementById('pickupTime').value}`;

  // üßæ ËØ∑Ê±Ç‰Ωì
  const payload = {
    message: orderText,
    remark: remark,
    paymentMethod: delivery
      ? document.getElementById('deliveryPayment').value
      : document.getElementById('pickupPayment').value,
    orderType: delivery ? 'delivery' : 'pickup',
    name: name,
    items: cart
  };

  // ‚úÖ Êèê‰∫§Âà∞ËøúÁ®ã Flask Render ÂêéÁ´Ø
  fetch('https://flask-order-api.onrender.com/submit_order', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(res => {
      if (res.paymentLink) {
        window.location.href = res.paymentLink;
      } else if (res.success || res.status === 'ok') {
        alert('Bestelling succesvol verzonden!');
        location.reload();
      } else {
        alert('Er is een fout opgetreden bij het verzenden van uw bestelling. Probeer het opnieuw.');
      }
    })
    .catch(() => alert('Verzendfout ‚Äì server niet bereikbaar.'));
}


</script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  const socket = io(window.location.origin, { transports: ['websocket'] });

  let pollTimer;

  window.addEventListener('beforeunload', () => socket.disconnect());

  socket.on('connect_error', () => {
    setTimeout(() => socket.connect(), 1000);
  });

  socket.on('disconnect', () => {
    console.warn('‚ö†Ô∏è Socket ËøûÊé•Êñ≠ÂºÄ');
    startPolling();
  });

  socket.on('connect', () => {
    console.log('‚úÖ Socket ËøûÊé•ÊàêÂäü');
    stopPolling();
  });

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function beep(){
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(660, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.2);
  }

  function addRow(order){
    const tbody = document.querySelector('.orders-panel tbody');
    if(!tbody) return;
    const tr = document.createElement('tr');
    if(order.id) tr.dataset.id = order.id;
    const isDelivery = ['delivery','bezorgen'].includes(order.order_type);
    const items = Object.entries(order.items || {}).map(([n,i]) => `<li>${n} x ${i.qty}</li>`).join('');
    const total = Object.values(order.items || {}).reduce((s,i)=>s + (parseFloat(i.price||0)*parseInt(i.qty||0)),0);
    tr.innerHTML = `
      <td>${order.created_at || ''}</td>
      <td>${isDelivery ? 'Bezorgen' : 'Afhalen'}</td>
      <td>${order.customer_name || ''}</td>
      <td>${order.phone || ''}</td>
      <td>${order.email || '-'}</td>
      <td><ul>${items}</ul></td>
      <td>${total.toFixed(2)}</td>
      <td>${isDelivery ? `${order.street} ${order.house_number} ${order.postcode} ${order.city}` : '-'}</td>
      <td>${isDelivery ? (order.delivery_time || '-') : (order.pickup_time || '-')}</td>
      <td>${order.payment_method || ''}</td>`;
    tbody.prepend(tr);
  }

  socket.on('new_order', order => {
    console.log('üÜï Êñ∞ËÆ¢Âçï:', order);
    beep();
    addRow(order);
  });

  function fetchOrders(){
    fetch('/pos/orders_today?json=1').then(r=>r.json()).then(data=>{
      const tbody = document.querySelector('.orders-panel tbody');
      if(!tbody) return;
      tbody.innerHTML='';
      data.forEach(addRow);
    }).catch(()=>{});
  }

  function startPolling(){
    if(pollTimer) return;
    fetchOrders();
    pollTimer = setInterval(fetchOrders,10000);
  }

  function stopPolling(){
    if(pollTimer){
      clearInterval(pollTimer);
      pollTimer = null;
    }
  }
  function beep() {
  const sound = document.getElementById("notifySound");
  if (sound) sound.play();
}

</script>
<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(660, audioCtx.currentTime);
  gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.2);
}
socket.on('new_order', order => {
  beep();
  alert(`Nieuwe bestelling ontvangen!\n\n${formatOrder(order)}`);
});
</script>
 <script>
function checkForNewOrders(){
  fetch('https://nova-asia.onrender.com/orders_today/json')   // ÊõøÊç¢Êàê‰Ω†ÁúüÂÆûÁöÑ API Ë∑ØÂæÑ
    .then(res => res.json())
    .then(orders => {
      orders.forEach(order => {
        if (!knownOrderIds.has(order.id)) {
          knownOrderIds.add(order.id);
          // Êí≠ÊîæÂ£∞Èü≥
          beep();
          // ÂèØÈÄâÔºöÂºπÁ™óÊèêÁ§∫
          alert(`Nieuwe bestelling ontvangen!\n\n${formatOrder(order)}`);
          // ‰Ω†ÂèØ‰ª•Âú®Ê≠§Â§ÑÊääËÆ¢ÂçïÊèíÂÖ• DOM ÊòæÁ§∫
          addOrderToDOM(order);  // ‰Ω†Ëá™Â∑±ÂÆö‰πâÁöÑÂáΩÊï∞
        }
      });
    })
    .catch(err => {
      console.error('Fout bij ophalen nieuwe bestellingen:', err);
    });
}
// ÊØè 5 ÁßíËΩÆËØ¢‰∏ÄÊ¨°ÊúçÂä°Âô®
setInterval(checkForNewOrders, 5000);   
</script>
 <script>
let knownOrderIds = new Set();  // ‰øùÂ≠òÂ∑≤Â§ÑÁêÜÁöÑËÆ¢Âçï ID
</script>


 
  
</body>
</html>

<style>
  .orders-wrapper {
    overflow-x: auto;
    max-width: 100%;
  }

.orders-wrapper {
    overflow-x: auto;
    display: block;
    width: 100%;
    max-width: 100vw;
  }

  table.orders-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1200px;
  }

  .orders-table th, .orders-table td {
    border: 1px solid #ccc;
    padding: 8px;
    white-space: nowrap;
    text-align: left;
  }

  .orders-table thead {
    background-color: #f9f9f9;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  td:last-child,
  th:last-child {
    padding-right: 20px;
  }

  .type-bezorging {
    color: red;
    font-weight: bold;
  }

  .type-afhalen {
    color: green;
    font-weight: bold;
  }
  .completed { background-color: #c8e6c9; }
  .cancelled { background-color: #e0e0e0; }
  
  table.orders-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1200px; /* ÈÅøÂÖçÂ§™Á™Ñ */
  }

  .orders-table th, .orders-table td {
    border: 1px solid #ccc;
    padding: 8px;
    white-space: nowrap; /* ‰∏çÊç¢Ë°å */
    text-align: left;
  }

  .orders-table thead {
    background-color: #f9f9f9;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  td:last-child,
th:last-child {
  padding-right: 20px;
}

</style>
<h1>Bestellingen Vandaag</h1>
<div class="orders-wrapper">
  <table class="orders-table">
    <thead>
      <tr>
       <th>Datum</th>
       <th>Tijd</th>
       <th>Type</th>
       <th>Naam</th>
       <th>Telefoon</th>
       <th>Email</th>
       <th>Items</th>
       <th>Opmerking</th>
       <th>Fooi</th>
       <th>Totaal</th>
       <th>Adres</th>
       <th>Tijdslot</th>
       <th>Betaalwijze</th>
       <th>Ordernummer</th>
       <th>Êìç‰Ωú</th>
      </tr>
    </thead>
    <tbody>
    {% for order in orders %}
      <tr class="{% if order.is_cancelled %}cancelled{% elif order.is_completed %}completed{% endif %}">
        {% set row_id = order.id %}
        <td>{{ order.created_at_local.strftime('%Y-%m-%d') }}</td>
        <td>{{ order.created_at_local.strftime('%H:%M') }}</td>
        {% set is_delivery = order.order_type in ['delivery', 'bezorgen'] %}
        <td>
          <span class="{{ 'type-bezorging' if is_delivery else 'type-afhalen' }}">
            {{ 'Bezorging' if is_delivery else 'Afhalen' }}
          </span>
        </td>
        <td>{{ order.customer_name or '' }}</td>
        <td>{{ order.phone or '' }}</td>
        <td>{{ order.email or '-' }}</td>
        <td>
          <ul>
          {% for name, item in order.items_dict.items() %}
            <li>{{ name }} x {{ item['qty'] }}</li>
          {% endfor %}
          </ul>
        </td>
       <td>{{ order.opmerking or '-' }}</td>
       <td>‚Ç¨{{ '%.2f' % (order.fooi or order.tip or 0) }}</td>

        <td>‚Ç¨{{ '%.2f' % (order.totaal or 0) }}</td>

        <td>
          {% if is_delivery %}
            {{ order.street }} {{ order.house_number }} {{ order.postcode }} {{ order.city }}
            {% if order.maps_link %}
              <a href="{{ order.maps_link }}" target="_blank">üìçMaps</a>
            {% endif %}
          {% else %}-{% endif %}
        </td>
        <td>
          {% if is_delivery %}
            {{ order.delivery_time or '-' }}
          {% else %}
            {{ order.pickup_time or '-' }}
          {% endif %}
        </td>
        <td>{{ order.payment_method }}</td>
        <td>{{ order.order_number or '' }}</td>
        <td>
          <button onclick="orderComplete(this)"
            data-id="{{ row_id }}"
            data-number="{{ order.order_number }}"
            data-name="{{ order.customer_name or '' }}"
            data-phone="{{ order.phone or '' }}"
            data-email="{{ order.email or '' }}"
            data-type="{{ 'bezorg' if is_delivery else 'afhaal' }}">
            {{ 'Undone' if order.is_completed else 'ËÆ¢ÂçïÂÆåÊàê' }}
          </button>
          <button onclick="editOrder(this)" data-id="{{ row_id }}">ÁºñËæë</button>
          <button onclick="cancelOrder(this)" data-id="{{ row_id }}">ÂèñÊ∂à</button>
          <span class="notify"></span>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<script>
  function orderComplete(btn) {
    const status = btn.nextElementSibling;
    const completed = btn.textContent.trim() !== 'Undone';
    fetch(`/api/orders/${btn.dataset.id}/complete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ completed })
    }).then(r => r.json()).then(() => {
      const row = btn.closest('tr');
      if (completed) {
        row.classList.add('completed');
        btn.textContent = 'Undone';
        const payload = {
          order_number: btn.dataset.number,
          name: btn.dataset.name,
          phone: btn.dataset.phone,
          email: btn.dataset.email,
          order_type: btn.dataset.type
        };
        fetch('https://flask-order-api.onrender.com/api/order_complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(() => { status.textContent = ''; }).catch(() => {});
      } else {
        row.classList.remove('completed');
        btn.textContent = 'ËÆ¢ÂçïÂÆåÊàê';
      }
    });
  }

  function cancelOrder(btn) {
    if (!confirm('Á°ÆÂÆöÂèñÊ∂àËØ•ËÆ¢Âçï?')) return;
    fetch(`/api/orders/${btn.dataset.id}/cancel`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cancel: true })
    }).then(() => {
      const row = btn.closest('tr');
      row.classList.remove('completed');
      row.classList.add('cancelled');
    });
  }

  function editOrder(btn) {
    const id = btn.dataset.id;
    const row = btn.closest('tr');
    const cells = row.children;
    const data = {
      customer_name: prompt('Naam', cells[3].textContent) || cells[3].textContent,
      phone: prompt('Telefoon', cells[4].textContent) || cells[4].textContent,
      email: prompt('Email', cells[5].textContent) || cells[5].textContent,
      street: prompt('Straat', cells[10].textContent.split(' ')[0]) || cells[10].textContent.split(' ')[0],
      house_number: prompt('Huisnummer', cells[10].textContent.split(' ')[1] || '') || cells[10].textContent.split(' ')[1] || '',
      postcode: prompt('Postcode', '') || '',
      city: prompt('Stad', '') || '',
      pickup_time: cells[11].textContent,
      delivery_time: cells[11].textContent,
      order_type: cells[2].textContent.toLowerCase() === 'bezorgen' ? 'bezorgen' : 'afhalen'
    };
    fetch(`/api/orders/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    }).then(() => {
      cells[3].textContent = data.customer_name;
      cells[4].textContent = data.phone;
      cells[5].textContent = data.email;
      cells[10].textContent = `${data.street} ${data.house_number}`;
    });
  }
</script>

<style>
.order-card {
  border: 1px solid #ccc;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  margin: 16px 0;
  padding: 16px;
  background-color: #fff;
  transition: box-shadow 0.2s ease;
}
.order-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.order-header {
  display: flex;
  justify-content: space-between;
  font-weight: bold;
  margin-bottom: 8px;
}
.order-details {
  margin-bottom: 8px;
}
.order-actions {
  display: flex;
  gap: 10px;
}
.completed .order-card { background-color: #e6f4ea; }
.cancelled .order-card { background-color: #f0f0f0; }
.type-afhalen { color: green; font-weight: bold; }
.type-bezorging { color: red; font-weight: bold; }
</style>

<div class="order-card {{ 'completed' if order.is_completed else '' }} {{ 'cancelled' if order.is_cancelled else '' }}">
  <div class="order-header">
    <div>{{ order.created_at_local.strftime('%H:%M') }} — 
      <span class="{{ 'type-bezorging' if is_delivery else 'type-afhalen' }}">
        {{ 'Bezorging' if is_delivery else 'Afhalen' }}
      </span>
    </div>
    <div>€{{ '%.2f' % (order.totaal or 0) }}</div>
  </div>

  <div class="order-details">
    <div><strong>Klant:</strong> {{ order.customer_name }}</div>
    <div><strong>Telefoon:</strong> {{ order.phone }}</div>
    <div><strong>Email:</strong> {{ order.email or '-' }}</div>
    <div><strong>Tijdslot:</strong> {{ order.delivery_time if is_delivery else order.pickup_time }}</div>
    <div><strong>Items:</strong>
      <ul>
        {% for name, item in order.items_dict.items() %}
        <li>{{ name }} x {{ item['qty'] }}</li>
        {% endfor %}
      </ul>
    </div>
    {% if is_delivery %}
    <div><strong>Adres:</strong> {{ order.street }} {{ order.house_number }} {{ order.postcode }} {{ order.city }}</div>
    {% endif %}
    <div><strong>Opmerking:</strong> {{ order.opmerking or '-' }}</div>
  </div>

  <div class="order-actions">
    <button onclick="toggleComplete(this)" ...>Klaar</button>
    <button onclick="editOrder(this)">Bewerk</button>
    <button onclick="cancelOrder(this)">Annuleer</button>
  </div>
</div>


<script>
  function orderComplete(btn) {
    const status = btn.nextElementSibling;
    const payload = {
      order_number: btn.dataset.number,
      name: btn.dataset.name,
      phone: btn.dataset.phone,
      email: btn.dataset.email,
      order_type: btn.dataset.type
    };
    fetch('https://flask-order-api.onrender.com/api/order_complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(r => {
      if (r.ok) {
        status.textContent = 'Notificatie verzonden';
      } else {
        status.textContent = 'Notificatie mislukt';
      }
    }).catch(() => {
      status.textContent = 'Notificatie mislukt';
    });
  }

  function toggleComplete(btn) {
    const tr = btn.closest('tr');
    const id = tr.dataset.id;
    const done = !tr.classList.contains('completed');
    fetch(`/api/orders/${id}/status`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({is_completed: done})
    }).then(r=>r.json()).then(() => {
      if(done) orderComplete(btn);
      fetchOrders();
    });
  }

  function cancelOrder(btn) {
    const id = btn.closest('tr').dataset.id;
    fetch(`/api/orders/${id}/status`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({is_cancelled: true})
    }).then(()=>fetchOrders());
  }

  function editOrder(btn) {
    const tr = btn.closest('tr');
    const id = tr.dataset.id;
    const data = JSON.parse(tr.dataset.order || '{}');
    const name = prompt('Naam', data.customer_name || '');
    if(name === null) return;
    const phone = prompt('Telefoon', data.phone || '');
    if(phone === null) return;
    const email = prompt('Email', data.email || '');
    if(email === null) return;
    const street = prompt('Straat', data.street || '');
    if(street === null) return;
    const number = prompt('Huisnummer', data.house_number || '');
    if(number === null) return;
    const postcode = prompt('Postcode', data.postcode || '');
    if(postcode === null) return;
    const city = prompt('Plaats', data.city || '');
    if(city === null) return;
    const pickup = prompt('Afhaaltijd', data.pickup_time || '');
    if(pickup === null) return;
    const delivery = prompt('Bezorgtijd', data.delivery_time || '');
    if(delivery === null) return;

    fetch(`/api/orders/${id}`, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        customer_name:name, phone, email,
        street, house_number:number, postcode, city,
        pickup_time:pickup, delivery_time:delivery
      })
    }).then(()=>fetchOrders());
  }
</script>
